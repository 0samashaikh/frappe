<div class="comment-view mb-6">
	{% if not comment_list %}
		<div class="no-comment">
			<p class="text-muted small">{{ _("No comments yet. Start a new discussion.") }}</p>
		</div>
	{% endif %}

	{% if not is_communication %}
		<div class="add-comment-section">
			<div class="text-muted hidden login-required">
				<a href="/login?redirect-to={{ pathname }}">{{ _("Login to comment") }}</a>
			</div>
			<div class="comment-form-wrapper">
				<div id="comment-form">
					<form class="new-comment">
						<fieldset class="new-comment-fields">
							<div class="user-details row" style="margin-bottom: 15px; display:none;">
								<div class="comment-by col-sm-6 pb-4">
									<div class="form-label mb-1">Your Name</div>
									<input class="form-control comment_by" name="comment_by" type="text">
								</div>
								<div class="col-sm-6">
									<div class="form-label mb-1">Email</div>
									<input class="form-control comment_email" name="comment_email" type="email">
								</div>
							</div>
							<div class="comment-text-area">
								<div class="form-label mb-1">Add a comment</div>
								<textarea class="form-control" name="comment" rows=5 ></textarea>
								<div class="text-muted small mt-1 mb-4">Ctrl+Enter to add comment</div>
							</div>
							<button class="btn btn-sm small" id="submit-comment">{{ _("Comment") }}</button>
						</fieldset>
					</form>
				</div>
			</div>
		</div>
	{% endif %}

	<div itemscope itemtype="http://schema.org/UserComments" id="comment-list">
		{% for comment in comment_list %}
			{% include "templates/includes/comments/comment.html" %}
		{% endfor %}
	</div>
</div>

<script>
	frappe.ready(function() {
		let guest_allowed = "{{ guest_allowed or ''}}";
		let comment_count = "{{ comment_text }}";

		let $comment_count = $(`
			<div class="comment-count">
				${frappe.utils.icon('small-message', 'md')}
			</div>
		`);

		$('.feedback-header').append($comment_count);

		$('form').keydown(function(event) {
			if (event.ctrlKey && event.keyCode === 13) {
				$(this).find('#submit-comment').trigger('click');
			}
		})

		let comment_timeline_height = $('#comment-list .comment-row:last-child').height() - 10;
		$('.blog-container')[0].style.setProperty('--comment-timeline-height', comment_timeline_height +'px');

		let update_count = function(name, count) {
			let text = count == 0 || count == 1 ? name : `${name}s`;

			$(`.${name.toLowerCase()}-count`).find('span').remove();

			$(`.${name.toLowerCase()}-count`).append(`
				<span>${text} ${count}</span>
			`);
		}

		update_count('Comment', comment_count);

		if (!frappe.is_user_logged_in()) {
			!guest_allowed && $(".login-required, .comment-form-wrapper").toggleClass("hidden");
		} else {
			$('input.comment_by').prop("disabled", true);
			$('input.comment_email').prop("disabled", true);
		}

		var n_comments = $(".comment-row").length;

		if(n_comments) {
			$(".no_comment").toggle(false);
		}
		if(n_comments > 50) {
			$(".add-comment").toggle(false)
				.parent().append("<div class='text-muted'>Comments are closed.</div>")
		}

		var full_name = "", user_id = "";
		if(frappe.is_user_logged_in()) {
			full_name = frappe.get_cookie("full_name");
			user_id = frappe.get_cookie("user_id");
			if(user_id != "Guest") {
				$("[name='comment_email']").val(user_id);
				$("[name='comment_by']").val(full_name);
			}
		} else {
			$(".user-details").toggle('hide');
		}
		$("#comment-form textarea").val("");

		$("#submit-comment").click(function() {
			var args = {
				comment_by: $("[name='comment_by']").val(),
				comment_email: $("[name='comment_email']").val(),
				comment: $("[name='comment']").val(),
				reference_doctype: "{{ reference_doctype or doctype }}",
				reference_name: "{{ reference_name or name }}",
				comment_type: "Comment",
				route: "{{ pathname }}",
			}

			if(!args.comment_by || !args.comment_email || !args.comment) {
				frappe.msgprint("{{ _("All fields are necessary to submit the comment.") }}");
				return false;
			}

			if (args.comment_email!=='Administrator' && !validate_email(args.comment_email)) {
				frappe.msgprint("{{ _("Please enter a valid email address.") }}");
				return false;
			}

			if(!args.comment || !args.comment.trim()) {
				frappe.msgprint("{{ _("Please add a valid comment.") }}");
				return false;
			}

			frappe.call({
				btn: this,
				type: "POST",
				method: "frappe.templates.includes.comments.comments.add_comment",
				args: args,
				callback: function(r) {
					if(r.exc) {
						if(r._server_messages)
							frappe.msgprint(r._server_messages);
					} else {
						if (r.message) {
							$(r.message).prependTo("#comment-list");
							comment_count = cint(comment_count) + 1;
							update_count('Comment', comment_count);
						}
						$(".no-comment, .add-comment").toggle(false);
						$("#comment-form textarea").val("");
					}
				}
			})

			return false;
		});
	});
</script>
